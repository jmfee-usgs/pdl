<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Product.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.product</a> &gt; <span class="el_source">Product.java</span></div><h1>Product.java</h1><pre class="source lang-java linenums">/*
 * Product
 */
package gov.usgs.earthquake.product;

import gov.usgs.util.CryptoUtils;
import gov.usgs.util.XmlUtils;

import java.security.PublicKey;
import java.security.PrivateKey;

import java.math.BigDecimal;
import java.net.URI;
import java.net.URL;

import java.util.Date;
import java.util.List;
import java.util.LinkedList;
import java.util.Map;
import java.util.HashMap;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * One or more pieces of Content with a unique id.
 */
public class Product {

<span class="fc" id="L29">	private static final Logger LOGGER = Logger.getLogger(Product.class</span>
<span class="fc" id="L30">			.getName());</span>

	/** The status message when a product is being updated. */
	public static final String STATUS_UPDATE = &quot;UPDATE&quot;;

	/** The status message when a product is being deleted. */
	public static final String STATUS_DELETE = &quot;DELETE&quot;;

	public static final String EVENTSOURCE_PROPERTY = &quot;eventsource&quot;;
	public static final String EVENTSOURCECODE_PROPERTY = &quot;eventsourcecode&quot;;
	public static final String EVENTTIME_PROPERTY = &quot;eventtime&quot;;
	public static final String MAGNITUDE_PROPERTY = &quot;magnitude&quot;;
	public static final String LATITUDE_PROPERTY = &quot;latitude&quot;;
	public static final String LONGITUDE_PROPERTY = &quot;longitude&quot;;
	public static final String DEPTH_PROPERTY = &quot;depth&quot;;
	public static final String VERSION_PROPERTY = &quot;version&quot;;

	/** A unique identifier for this product. */
	private ProductId id;

	/** A terse status message. */
	private String status;

	/** Properties of this product. */
<span class="fc" id="L54">	private Map&lt;String, String&gt; properties = new HashMap&lt;String, String&gt;();</span>

	/** Links to other products and related resources. */
<span class="fc" id="L57">	private Map&lt;String, List&lt;URI&gt;&gt; links = new HashMap&lt;String, List&lt;URI&gt;&gt;();</span>

	/** Product contents. Mapping from path to content. */
<span class="fc" id="L60">	private Map&lt;String, Content&gt; contents = new HashMap&lt;String, Content&gt;();</span>

	/** A URL where status updates are sent. */
<span class="fc" id="L63">	private URL trackerURL = null;</span>

	/** A signature generated by the product creator. */
<span class="fc" id="L66">	private String signature = null;</span>

	/**
	 * Construct a new Product with status &quot;UPDATE&quot;.
	 * 
	 * @param id
	 *            the product's unique Id.
	 */
	public Product(final ProductId id) {
<span class="fc" id="L75">		this(id, STATUS_UPDATE);</span>
<span class="fc" id="L76">	}</span>

	/**
	 * Construct a new Product.
	 * 
	 * @param id
	 *            the product's unique Id.
	 * @param status
	 *            the product's status.
	 */
<span class="fc" id="L86">	public Product(final ProductId id, final String status) {</span>
<span class="fc" id="L87">		setId(id);</span>
<span class="fc" id="L88">		setStatus(status);</span>
<span class="fc" id="L89">	}</span>

	/**
	 * Copy constructor.
	 * 
	 * @param that
	 *            the product to copy.
	 */
	public Product(final Product that) {
<span class="fc" id="L98">		this(new ProductId(that.getId().getSource(), that.getId().getType(),</span>
<span class="fc" id="L99">				that.getId().getCode(), that.getId().getUpdateTime()), that</span>
<span class="fc" id="L100">				.getStatus());</span>
<span class="fc" id="L101">		this.setTrackerURL(that.getTrackerURL());</span>
<span class="fc" id="L102">		this.setProperties(that.getProperties());</span>
<span class="fc" id="L103">		this.setLinks(that.getLinks());</span>
<span class="fc" id="L104">		this.setContents(that.getContents());</span>
<span class="fc" id="L105">		this.setSignature(that.getSignature());</span>
<span class="fc" id="L106">	}</span>

	/**
	 * @return the id
	 */
	public ProductId getId() {
<span class="fc" id="L112">		return id;</span>
	}

	/**
	 * @param id
	 *            the id to set
	 */
	public void setId(final ProductId id) {
<span class="fc" id="L120">		this.id = id;</span>
<span class="fc" id="L121">	}</span>

	/**
	 * @return the status
	 */
	public String getStatus() {
<span class="fc" id="L127">		return status;</span>
	}

	/**
	 * @param status
	 *            the status to set
	 */
	public void setStatus(final String status) {
<span class="fc" id="L135">		this.status = status;</span>
<span class="fc" id="L136">	}</span>

	/**
	 * Product.STATUS_DELETE.equalsIgnoreCase(status).
	 * 
	 * @return whether this product is deleted
	 */
	public boolean isDeleted() {
<span class="nc bnc" id="L144" title="All 2 branches missed.">		if (STATUS_DELETE.equalsIgnoreCase(this.status)) {</span>
<span class="nc" id="L145">			return true;</span>
		} else {
<span class="nc" id="L147">			return false;</span>
		}
	}

	/**
	 * @return the properties
	 */
	public Map&lt;String, String&gt; getProperties() {
<span class="fc" id="L155">		return properties;</span>
	}

	/**
	 * @param properties
	 *            the properties to set
	 */
	public void setProperties(final Map&lt;String, String&gt; properties) {
<span class="fc" id="L163">		this.properties.putAll(properties);</span>
<span class="fc" id="L164">	}</span>

	/**
	 * Returns a reference to the links map.
	 * 
	 * @return the links
	 */
	public Map&lt;String, List&lt;URI&gt;&gt; getLinks() {
<span class="fc" id="L172">		return links;</span>
	}

	/**
	 * Copies entries from provided map.
	 * 
	 * @param links
	 *            the links to set
	 */
	public void setLinks(final Map&lt;String, List&lt;URI&gt;&gt; links) {
<span class="fc" id="L182">		this.links.putAll(links);</span>
<span class="fc" id="L183">	}</span>

	/**
	 * Add a link to a product.
	 * 
	 * @param relation
	 *            how link is related to product.
	 * @param href
	 *            actual link.
	 */
	public void addLink(final String relation, final URI href) {
<span class="fc" id="L194">		List&lt;URI&gt; relationLinks = links.get(relation);</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">		if (relationLinks == null) {</span>
<span class="fc" id="L196">			relationLinks = new LinkedList&lt;URI&gt;();</span>
<span class="fc" id="L197">			links.put(relation, relationLinks);</span>
		}
<span class="fc" id="L199">		relationLinks.add(href);</span>
<span class="fc" id="L200">	}</span>

	/**
	 * Returns a reference to the contents map.
	 * 
	 * @return the contents
	 */
	public Map&lt;String, Content&gt; getContents() {
<span class="fc" id="L208">		return contents;</span>
	}

	/**
	 * Copies entries from provided map.
	 * 
	 * @param contents
	 *            the contents to set
	 */
	public void setContents(final Map&lt;String, Content&gt; contents) {
<span class="fc" id="L218">		this.contents.clear();</span>
<span class="fc" id="L219">		this.contents.putAll(contents);</span>
<span class="fc" id="L220">	}</span>

	/**
	 * @return the trackerURL
	 */
	public URL getTrackerURL() {
<span class="fc" id="L226">		return trackerURL;</span>
	}

	/**
	 * @param trackerURL
	 *            the trackerURL to set
	 */
	public void setTrackerURL(final URL trackerURL) {
<span class="fc" id="L234">		this.trackerURL = trackerURL;</span>
<span class="fc" id="L235">	}</span>

	/**
	 * @return the signature
	 */
	public String getSignature() {
<span class="fc" id="L241">		return signature;</span>
	}

	/**
	 * @param signature
	 *            the signature to set
	 */
	public void setSignature(final String signature) {
<span class="fc" id="L249">		this.signature = signature;</span>
<span class="fc" id="L250">	}</span>

	/**
	 * Sign this product using a PrivateKey.
	 * 
	 * @param privateKey
	 *            a DSAPrivateKey or RSAPrivateKey.
	 * @throws Exception
	 */
	public void sign(final PrivateKey privateKey) throws Exception {
<span class="fc" id="L260">		setSignature(CryptoUtils.sign(privateKey,</span>
<span class="fc" id="L261">				ProductDigest.digestProduct(this)));</span>
<span class="fc" id="L262">	}</span>

	/**
	 * Verify this product's signature.
	 * 
	 * When a product has no signature, this method returns false. The array of
	 * public keys corresponds to one or more keys that may have generated the
	 * signature. If any of the keys verify, this method returns true.
	 * 
	 * @param publicKeys
	 *            an array of publicKeys to test.
	 * @return true if valid, false otherwise.
	 * @throws Exception
	 */
	public boolean verifySignature(final PublicKey[] publicKeys)
			throws Exception {
<span class="fc bfc" id="L278" title="All 2 branches covered.">		if (signature == null) {</span>
<span class="fc" id="L279">			return false;</span>
		}

<span class="fc" id="L282">		byte[] digest = ProductDigest.digestProduct(this);</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">		for (PublicKey key : publicKeys) {</span>
			try {
<span class="fc bfc" id="L285" title="All 2 branches covered.">				if (CryptoUtils.verify(key, digest, getSignature())) {</span>
<span class="fc" id="L286">					return true;</span>
				}
<span class="nc" id="L288">			} catch (Exception e) {</span>
<span class="nc" id="L289">				LOGGER.log(Level.FINEST, &quot;Exception while verifying signature&quot;,</span>
						e);
<span class="fc" id="L291">			}</span>
		}
<span class="fc" id="L293">		return false;</span>
	}

	/**
	 * Get the event id.
	 * 
	 * The event id is the combination of event source and event source code.
	 * 
	 * @return the event id, or null if either event source or event source code
	 *         is null.
	 */
	public String getEventId() {
<span class="fc" id="L305">		String eventSource = getEventSource();</span>
<span class="fc" id="L306">		String eventSourceCode = getEventSourceCode();</span>
<span class="pc bpc" id="L307" title="1 of 4 branches missed.">		if (eventSource == null &amp;&amp; eventSourceCode == null) {</span>
<span class="fc" id="L308">			return null;</span>
		}
<span class="fc" id="L310">		return (eventSource + eventSourceCode).toLowerCase();</span>
	}

	/**
	 * Set both the network and networkId at the same time.
	 * 
	 * @param source
	 *            the originating network.
	 * @param sourceCode
	 *            the originating network's id.
	 */
	public void setEventId(final String source, final String sourceCode) {
<span class="fc" id="L322">		setEventSource(source);</span>
<span class="fc" id="L323">		setEventSourceCode(sourceCode);</span>
<span class="fc" id="L324">	}</span>

	/**
	 * Get the event source property.
	 * 
	 * @return the event source property, or null if no event source property
	 *         set.
	 */
	public String getEventSource() {
<span class="fc" id="L333">		return this.properties.get(EVENTSOURCE_PROPERTY);</span>
	}

	/**
	 * Set the event source property.
	 * 
	 * @param eventSource
	 *            the event source to set.
	 */
	public void setEventSource(final String eventSource) {
<span class="fc bfc" id="L343" title="All 2 branches covered.">		if (eventSource == null) {</span>
<span class="fc" id="L344">			this.properties.remove(EVENTSOURCE_PROPERTY);</span>
		} else {
<span class="fc" id="L346">			this.properties</span>
<span class="fc" id="L347">					.put(EVENTSOURCE_PROPERTY, eventSource.toLowerCase());</span>
		}
<span class="fc" id="L349">	}</span>

	/**
	 * Get the event source code property.
	 * 
	 * @return the event source code property, or null if no event source code
	 *         property set.
	 */
	public String getEventSourceCode() {
<span class="fc" id="L358">		return this.properties.get(EVENTSOURCECODE_PROPERTY);</span>
	}

	/**
	 * Set the event id property.
	 * 
	 * @param eventSourceCode
	 *            the event id to set.
	 */
	public void setEventSourceCode(final String eventSourceCode) {
<span class="fc bfc" id="L368" title="All 2 branches covered.">		if (eventSourceCode == null) {</span>
<span class="fc" id="L369">			this.properties.remove(EVENTSOURCECODE_PROPERTY);</span>
		} else {
<span class="fc" id="L371">			this.properties.put(EVENTSOURCECODE_PROPERTY,</span>
<span class="fc" id="L372">					eventSourceCode.toLowerCase());</span>
		}
<span class="fc" id="L374">	}</span>

	/**
	 * Get the event time property as a date.
	 * 
	 * @return the event time property as a date, or null if no date property
	 *         set.
	 */
	public Date getEventTime() {
<span class="fc" id="L383">		String strDate = this.properties.get(EVENTTIME_PROPERTY);</span>
<span class="fc bfc" id="L384" title="All 2 branches covered.">		if (strDate == null) {</span>
<span class="fc" id="L385">			return null;</span>
		}
<span class="fc" id="L387">		return XmlUtils.getDate(strDate);</span>
	}

	/**
	 * Set the event time property as a date.
	 * 
	 * @param eventTime
	 *            the event time to set.
	 */
	public void setEventTime(final Date eventTime) {
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">		if (eventTime == null) {</span>
<span class="nc" id="L398">			this.properties.remove(EVENTTIME_PROPERTY);</span>
		} else {
<span class="fc" id="L400">			this.properties.put(EVENTTIME_PROPERTY,</span>
<span class="fc" id="L401">					XmlUtils.formatDate(eventTime));</span>
		}
<span class="fc" id="L403">	}</span>

	/**
	 * Get the magnitude property as a big decimal.
	 * 
	 * @return the magnitude property as a big decimal, or null if no magnitude
	 *         property set.
	 */
	public BigDecimal getMagnitude() {
<span class="fc" id="L412">		String strMag = this.properties.get(MAGNITUDE_PROPERTY);</span>
<span class="fc bfc" id="L413" title="All 2 branches covered.">		if (strMag == null) {</span>
<span class="fc" id="L414">			return null;</span>
		}
<span class="fc" id="L416">		return new BigDecimal(strMag);</span>
	}

	/**
	 * Set the magnitude property as a big decimal.
	 * 
	 * @param magnitude
	 *            the magnitude to set.
	 */
	public void setMagnitude(final BigDecimal magnitude) {
<span class="pc bpc" id="L426" title="1 of 2 branches missed.">		if (magnitude == null) {</span>
<span class="nc" id="L427">			this.properties.remove(MAGNITUDE_PROPERTY);</span>
		} else {
<span class="fc" id="L429">			this.properties.put(MAGNITUDE_PROPERTY, magnitude.toPlainString());</span>
		}
<span class="fc" id="L431">	}</span>

	/**
	 * Get the latitude property as a big decimal.
	 * 
	 * @return latitude property as a big decimal, or null if no latitude
	 *         property set.
	 */
	public BigDecimal getLatitude() {
<span class="fc" id="L440">		String strLat = this.properties.get(LATITUDE_PROPERTY);</span>
<span class="fc bfc" id="L441" title="All 2 branches covered.">		if (strLat == null) {</span>
<span class="fc" id="L442">			return null;</span>
		}
<span class="fc" id="L444">		return new BigDecimal(strLat);</span>
	}

	/**
	 * Set the latitude property as a big decimal.
	 * 
	 * @param latitude
	 *            the latitude to set.
	 */
	public void setLatitude(final BigDecimal latitude) {
<span class="pc bpc" id="L454" title="1 of 2 branches missed.">		if (latitude == null) {</span>
<span class="nc" id="L455">			this.properties.remove(LATITUDE_PROPERTY);</span>
		} else {
<span class="fc" id="L457">			this.properties.put(LATITUDE_PROPERTY, latitude.toPlainString());</span>
		}
<span class="fc" id="L459">	}</span>

	/**
	 * Get the longitude property as a big decimal.
	 * 
	 * @return longitude property as a big decimal, or null if no longitude
	 *         property set.
	 */
	public BigDecimal getLongitude() {
<span class="fc" id="L468">		String strLon = this.properties.get(LONGITUDE_PROPERTY);</span>
<span class="fc bfc" id="L469" title="All 2 branches covered.">		if (strLon == null) {</span>
<span class="fc" id="L470">			return null;</span>
		}
<span class="fc" id="L472">		return new BigDecimal(strLon);</span>
	}

	/**
	 * Set the longitude property as a big decimal.
	 * 
	 * @param longitude
	 *            the longitude to set.
	 */
	public void setLongitude(final BigDecimal longitude) {
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">		if (longitude == null) {</span>
<span class="nc" id="L483">			this.properties.remove(LONGITUDE_PROPERTY);</span>
		} else {
<span class="fc" id="L485">			this.properties.put(LONGITUDE_PROPERTY, longitude.toPlainString());</span>
		}
<span class="fc" id="L487">	}</span>

	/**
	 * Get the depth property as a big decimal.
	 * 
	 * @return depth property as big decimal, or null if no depth property set.
	 */
	public BigDecimal getDepth() {
<span class="fc" id="L495">		String strDepth = this.properties.get(DEPTH_PROPERTY);</span>
<span class="fc bfc" id="L496" title="All 2 branches covered.">		if (strDepth == null) {</span>
<span class="fc" id="L497">			return null;</span>
		}
<span class="fc" id="L499">		return new BigDecimal(strDepth);</span>
	}

	/**
	 * Set the depth property as a big decimal.
	 * 
	 * @param depth
	 *            the depth to set.
	 */
	public void setDepth(final BigDecimal depth) {
<span class="pc bpc" id="L509" title="1 of 2 branches missed.">		if (depth == null) {</span>
<span class="nc" id="L510">			this.properties.remove(DEPTH_PROPERTY);</span>
		} else {
<span class="fc" id="L512">			this.properties.put(DEPTH_PROPERTY, depth.toPlainString());</span>
		}
<span class="fc" id="L514">	}</span>

	/**
	 * Get the version property.
	 * 
	 * @return the version property, or null if no version property set.
	 */
	public String getVersion() {
<span class="fc" id="L522">		return this.properties.get(VERSION_PROPERTY);</span>
	}

	/**
	 * Set the version property.
	 * 
	 * @param version
	 *            the version to set.
	 */
	public void setVersion(final String version) {
<span class="pc bpc" id="L532" title="1 of 2 branches missed.">		if (version == null) {</span>
<span class="nc" id="L533">			this.properties.remove(VERSION_PROPERTY);</span>
		} else {
<span class="fc" id="L535">			this.properties.put(VERSION_PROPERTY, version);</span>
		}
<span class="fc" id="L537">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>