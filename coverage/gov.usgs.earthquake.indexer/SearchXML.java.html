<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchXML.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.indexer</a> &gt; <span class="el_source">SearchXML.java</span></div><h1>SearchXML.java</h1><pre class="source lang-java linenums">package gov.usgs.earthquake.indexer;

import gov.usgs.earthquake.distribution.FileProductStorage;
import gov.usgs.earthquake.product.Content;
import gov.usgs.earthquake.product.Product;
import gov.usgs.earthquake.product.ProductId;
import gov.usgs.earthquake.product.io.XmlProductHandler;
import gov.usgs.util.XmlUtils;

import java.io.InputStream;
import java.io.OutputStream;
import java.io.OutputStreamWriter;
import java.net.URI;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

/**
 * XML (de)serialization for SearchRequest and SearchResponse.
 * 
 */
<span class="nc" id="L22">public class SearchXML {</span>

	public static final String INDEXER_XMLNS = &quot;http://earthquake.usgs.gov/distribution/indexer&quot;;

	public static final String REQUEST_ELEMENT = &quot;searchrequest&quot;;
	public static final String RESPONSE_ELEMENT = &quot;searchresponse&quot;;

	public static final String RESULT_ELEMENT = &quot;result&quot;;
	public static final String QUERY_ELEMENT = &quot;query&quot;;
	public static final String EVENT_ELEMENT = &quot;event&quot;;
	public static final String ERROR_ELEMENT = &quot;error&quot;;

	public static final String METHOD_ATTRIBUTE = &quot;method&quot;;

	public static final String EVENT_SOURCE_ATTRIBUTE = &quot;eventSource&quot;;
	public static final String EVENT_SOURCE_CODE_ATTRIBUTE = &quot;eventSourceCode&quot;;
	public static final String MIN_EVENT_TIME_ATTRIBUTE = &quot;minEventTime&quot;;
	public static final String MAX_EVENT_TIME_ATTRIBUTE = &quot;maxEventTime&quot;;
	public static final String MIN_EVENT_LATITUDE_ATTRIBUTE = &quot;minEventLatitude&quot;;
	public static final String MAX_EVENT_LATITUDE_ATTRIBUTE = &quot;maxEventLatitude&quot;;
	public static final String MIN_EVENT_LONGITUDE_ATTRIBUTE = &quot;minEventLongitude&quot;;
	public static final String MAX_EVENT_LONGITUDE_ATTRIBUTE = &quot;maxEventLongitude&quot;;
	public static final String MIN_EVENT_DEPTH_ATTRIBUTE = &quot;minEventDepth&quot;;
	public static final String MAX_EVENT_DEPTH_ATTRIBUTE = &quot;maxEventDepth&quot;;
	public static final String MIN_EVENT_MAGNITUDE_ATTRIBUTE = &quot;minEventMagnitude&quot;;
	public static final String MAX_EVENT_MAGNITUDE_ATTRIBUTE = &quot;maxEventMagnitude&quot;;
	public static final String MIN_PRODUCT_UPDATE_TIME_ATTRIBUTE = &quot;minProductUpdateTime&quot;;
	public static final String MAX_PRODUCT_UPDATE_TIME_ATTRIBUTE = &quot;maxProductUpdateTime&quot;;
	public static final String PRODUCT_SOURCE_ATTRIBUTE = &quot;productSource&quot;;
	public static final String PRODUCT_TYPE_ATTRIBUTE = &quot;productType&quot;;
	public static final String PRODUCT_CODE_ATTRIBUTE = &quot;productCode&quot;;
	public static final String PRODUCT_VERSION_ATTRIBUTE = &quot;productVersion&quot;;
	public static final String PRODUCT_STATUS_ATTRIBUTE = &quot;productStatus&quot;;

	public static final String EVENT_SUMMARY_ELEMENT = &quot;eventSummary&quot;;
	public static final String PRODUCT_SUMMARY_ELEMENT = &quot;productSummary&quot;;

	public static final String ID_ATTRIBUTE = &quot;id&quot;;
	public static final String UPDATE_TIME_ATTRIBUTE = &quot;updateTime&quot;;
	public static final String STATUS_ATTRIBUTE = &quot;status&quot;;
	public static final String SOURCE_ATTRIBUTE = &quot;source&quot;;
	public static final String SOURCE_CODE_ATTRIBUTE = &quot;sourceCode&quot;;
	public static final String TIME_ATTRIBUTE = &quot;time&quot;;
	public static final String LATITUDE_ATTRIBUTE = &quot;latitude&quot;;
	public static final String LONGITUDE_ATTRIBUTE = &quot;longitude&quot;;
	public static final String DEPTH_ATTRIBUTE = &quot;depth&quot;;
	public static final String MAGNITUDE_ATTRIBUTE = &quot;magnitude&quot;;
	public static final String VERSION_ATTRIBUTE = &quot;version&quot;;
	public static final String PREFERRED_WEIGHT_ATTRIBUTE = &quot;preferredWeight&quot;;

	/**
	 * Parse an input stream with xml to a SearchRequest object.
	 * 
	 * @param in
	 *            the input stream containing xml.
	 * @return the parsed SearchRequest object.
	 */
	public static SearchRequest parseRequest(final InputStream in)
			throws Exception {
<span class="fc" id="L81">		SearchRequestParser parser = new SearchRequestParser();</span>
<span class="fc" id="L82">		XmlUtils.parse(in, parser);</span>
<span class="fc" id="L83">		return parser.getSearchRequest();</span>
	}

	/**
	 * Parse an input stream with xml to a SearchResponse object.
	 * 
	 * @param in
	 *            the input stream containing xml.
	 * @param storage
	 *            the storage where received products are stored.
	 * @return the parsed SearchResponse object.
	 * @throws Exception
	 */
	public static SearchResponse parseResponse(final InputStream in,
			final FileProductStorage storage) throws Exception {
<span class="fc" id="L98">		SearchResponseParser parser = new SearchResponseParser(storage);</span>
<span class="fc" id="L99">		XmlUtils.parse(in, parser);</span>
<span class="fc" id="L100">		return parser.getSearchResponse();</span>
	}

	/**
	 * Convert a SearchRequest object to xml.
	 * 
	 * @param request
	 *            the search request object to convert.
	 * @param out
	 *            the output stream where xml is written.
	 * @throws Exception
	 */
	public static void toXML(final SearchRequest request, final OutputStream out)
			throws Exception {
<span class="fc" id="L114">		OutputStreamWriter outStream = new OutputStreamWriter(out);</span>
<span class="fc" id="L115">		outStream.write(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&quot;);</span>
<span class="fc" id="L116">		outStream.write(&quot;&lt;&quot; + REQUEST_ELEMENT);</span>
<span class="fc" id="L117">		outStream.write(&quot; xmlns=\&quot;&quot; + INDEXER_XMLNS + &quot;\&quot;&quot;);</span>
<span class="fc" id="L118">		outStream.write(&quot;&gt;&quot;);</span>
<span class="fc" id="L119">		List&lt;SearchQuery&gt; queries = request.getQueries();</span>
<span class="fc" id="L120">		for (Iterator&lt;SearchQuery&gt; queryIterator = queries.iterator(); queryIterator</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">				.hasNext();) {</span>
<span class="fc" id="L122">			SearchQuery query = queryIterator.next();</span>
<span class="fc" id="L123">			outStream.write(getQueryXMLString(query));</span>
<span class="fc" id="L124">		}</span>
<span class="fc" id="L125">		outStream.write(&quot;&lt;/&quot; + REQUEST_ELEMENT + &quot;&gt;&quot;);</span>
<span class="fc" id="L126">		outStream.flush();</span>
<span class="fc" id="L127">	}</span>

	/**
	 * Convert a SearchResponse object to xml.
	 * 
	 * @param response
	 *            the search response object to convert.
	 * @param out
	 *            the output stream where xml is written.
	 * @throws Exception
	 */
	public static void toXML(final SearchResponse response,
			final OutputStream out) throws Exception {
<span class="fc" id="L140">		OutputStreamWriter writer = new OutputStreamWriter(out);</span>
<span class="fc" id="L141">		writer.write(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&quot;);</span>
<span class="fc" id="L142">		writer.write(&quot;&lt;&quot; + RESPONSE_ELEMENT);</span>
<span class="fc" id="L143">		writer.write(&quot; xmlns=\&quot;&quot; + INDEXER_XMLNS + &quot;\&quot;&quot;);</span>
<span class="fc" id="L144">		writer.write(&quot; xmlns:product=\&quot;&quot;</span>
				+ XmlProductHandler.PRODUCT_XML_NAMESPACE + &quot;\&quot;&quot;);
<span class="fc" id="L146">		writer.write(&quot;&gt;&quot;);</span>
<span class="fc" id="L147">		List&lt;SearchQuery&gt; results = response.getResults();</span>
<span class="fc" id="L148">		for (Iterator&lt;SearchQuery&gt; resultsIterator = results.iterator(); resultsIterator</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">				.hasNext();) {</span>
<span class="fc" id="L150">			SearchQuery result = resultsIterator.next();</span>
<span class="fc" id="L151">			writer.write(&quot;&lt;&quot; + RESULT_ELEMENT);</span>
<span class="fc" id="L152">			writer.write(&quot; &quot; + METHOD_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L153">					+ result.getType().getXmlMethodName() + &quot;\&quot;&quot;);</span>
<span class="fc" id="L154">			writer.write(&quot;&gt;&quot;);</span>
<span class="fc" id="L155">			writer.write(getQueryXMLString(result));</span>

<span class="fc bfc" id="L157" title="All 2 branches covered.">			if (result.getType() == SearchMethod.EVENT_DETAIL) {</span>
<span class="fc" id="L158">				EventDetailQuery edResult = (EventDetailQuery) result;</span>
<span class="fc" id="L159">				List&lt;Event&gt; events = edResult.getResult();</span>
<span class="fc" id="L160">				for (Iterator&lt;Event&gt; eventIter = events.iterator(); eventIter</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">						.hasNext();) {</span>
<span class="fc" id="L162">					Event event = eventIter.next();</span>
<span class="fc" id="L163">					writer.write(&quot;&lt;&quot; + EVENT_ELEMENT);</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">					if (event.getSource() != null)</span>
<span class="nc" id="L165">						writer.write(&quot; &quot; + SOURCE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L166">								+ event.getSource() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">					if (event.getSourceCode() != null)</span>
<span class="nc" id="L168">						writer.write(&quot; &quot; + SOURCE_CODE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L169">								+ event.getSourceCode() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">					if (event.getTime() != null)</span>
<span class="nc" id="L171">						writer.write(&quot; &quot; + TIME_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L172">								+ XmlUtils.formatDate(event.getTime()) + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">					if (event.getLatitude() != null)</span>
<span class="nc" id="L174">						writer.write(&quot; &quot; + LATITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L175">								+ event.getLatitude().toString() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">					if (event.getLongitude() != null)</span>
<span class="nc" id="L177">						writer.write(&quot; &quot; + LONGITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L178">								+ event.getLongitude().toString() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">					if (event.getDepth() != null)</span>
<span class="nc" id="L180">						writer.write(&quot; &quot; + DEPTH_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L181">								+ event.getDepth().toString() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">					if (event.getMagnitude() != null)</span>
<span class="nc" id="L183">						writer.write(&quot; &quot; + MAGNITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L184">								+ event.getMagnitude().toString() + &quot;\&quot;&quot;);</span>
<span class="fc" id="L185">					writer.write(&quot;&gt;&quot;);</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">					if (!event.getProducts().isEmpty()) {</span>
<span class="fc" id="L187">						Map&lt;String, List&lt;ProductSummary&gt;&gt; products = event</span>
<span class="fc" id="L188">								.getProducts();</span>
<span class="fc" id="L189">						for (Iterator&lt;String&gt; prodIter = products.keySet()</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">								.iterator(); prodIter.hasNext();) {</span>
<span class="fc" id="L191">							String prodType = prodIter.next();</span>
<span class="fc" id="L192">							for (Iterator&lt;ProductSummary&gt; summaryIter = products</span>
<span class="fc" id="L193">									.get(prodType).iterator(); summaryIter</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">									.hasNext();) {</span>
<span class="fc" id="L195">								writer.write(getProductSummaryXmlString(summaryIter</span>
<span class="fc" id="L196">										.next()));</span>
							}
<span class="fc" id="L198">						}</span>
					}
<span class="fc" id="L200">					writer.write(&quot;&lt;/&quot; + EVENT_ELEMENT + &quot;&gt;&quot;);</span>
<span class="fc" id="L201">				}</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">			} else if (result.getType() == SearchMethod.EVENTS_SUMMARY) {</span>
<span class="fc" id="L203">				EventsSummaryQuery esResult = (EventsSummaryQuery) result;</span>
<span class="fc" id="L204">				List&lt;EventSummary&gt; summaries = esResult.getResult();</span>
<span class="fc" id="L205">				for (Iterator&lt;EventSummary&gt; summaryIter = summaries.iterator(); summaryIter</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">						.hasNext();) {</span>
<span class="fc" id="L207">					writer.write(&quot;&lt;&quot; + EVENT_SUMMARY_ELEMENT);</span>
<span class="fc" id="L208">					EventSummary summary = summaryIter.next();</span>
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">					if (summary.getSource() != null)</span>
<span class="fc" id="L210">						writer.write(&quot; &quot; + SOURCE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L211">								+ summary.getSource() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">					if (summary.getSourceCode() != null)</span>
<span class="fc" id="L213">						writer.write(&quot; &quot; + SOURCE_CODE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L214">								+ summary.getSourceCode() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">					if (summary.getTime() != null)</span>
<span class="fc" id="L216">						writer.write(&quot; &quot; + TIME_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L217">								+ XmlUtils.formatDate(summary.getTime()) + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">					if (summary.getLatitude() != null)</span>
<span class="fc" id="L219">						writer.write(&quot; &quot; + LATITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L220">								+ summary.getLatitude().toString() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">					if (summary.getLongitude() != null)</span>
<span class="fc" id="L222">						writer.write(&quot; &quot; + LONGITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L223">								+ summary.getLongitude().toString() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">					if (summary.getDepth() != null)</span>
<span class="fc" id="L225">						writer.write(&quot; &quot; + DEPTH_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L226">								+ summary.getDepth().toString() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">					if (summary.getMagnitude() != null)</span>
<span class="fc" id="L228">						writer.write(&quot; &quot; + MAGNITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L229">								+ summary.getMagnitude().toString() + &quot;\&quot;&quot;);</span>
<span class="fc" id="L230">					writer.write(&quot;&gt;&quot;);</span>
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">					if (!summary.getProperties().isEmpty()) {</span>
<span class="fc" id="L232">						Map&lt;String, String&gt; properties = summary</span>
<span class="fc" id="L233">								.getProperties();</span>
<span class="fc" id="L234">						for (Iterator&lt;String&gt; propIter = properties.keySet()</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">								.iterator(); propIter.hasNext();) {</span>
<span class="fc" id="L236">							String property = propIter.next();</span>
<span class="fc" id="L237">							String value = properties.get(property);</span>
<span class="fc" id="L238">							writer.write(&quot;&lt;product:&quot;</span>
									+ XmlProductHandler.PROPERTY_ELEMENT);
<span class="fc" id="L240">							writer.write(&quot; &quot;</span>
									+ XmlProductHandler.PROPERTY_ATTRIBUTE_NAME
									+ &quot;=\&quot;&quot; + property + &quot;\&quot;&quot;);
<span class="fc" id="L243">							writer.write(&quot; &quot;</span>
									+ XmlProductHandler.PROPERTY_ATTRIBUTE_VALUE
									+ &quot;=\&quot;&quot; + value + &quot;\&quot;&quot;);
<span class="fc" id="L246">							writer.write(&quot; /&gt;&quot;);</span>
<span class="fc" id="L247">						}</span>
					}
<span class="fc" id="L249">					writer.write(&quot;&lt;/&quot; + EVENT_SUMMARY_ELEMENT + &quot;&gt;&quot;);</span>
<span class="fc" id="L250">				}</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">			} else if (result.getType() == SearchMethod.PRODUCT_DETAIL) {</span>
<span class="fc" id="L252">				ProductDetailQuery pdResult = (ProductDetailQuery) result;</span>
<span class="fc" id="L253">				List&lt;Product&gt; products = pdResult.getResult();</span>
<span class="fc" id="L254">				writer.flush();</span>
<span class="fc" id="L255">				for (Iterator&lt;Product&gt; prodIter = products.iterator(); prodIter</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">						.hasNext();) {</span>
<span class="fc" id="L257">					Product product = prodIter.next();</span>
<span class="fc" id="L258">					XmlProductHandler handler = new XmlProductHandler(out, false);</span>
<span class="fc" id="L259">					handler.onBeginProduct(product.getId(),</span>
<span class="fc" id="L260">							product.getStatus(), product.getTrackerURL());</span>
<span class="fc" id="L261">					Map&lt;String, String&gt; properties = product.getProperties();</span>
<span class="fc" id="L262">					for (Iterator&lt;String&gt; propIter = properties.keySet()</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">							.iterator(); propIter.hasNext();) {</span>
<span class="fc" id="L264">						String name = propIter.next();</span>
<span class="fc" id="L265">						handler.onProperty(product.getId(), name,</span>
<span class="fc" id="L266">								properties.get(name));</span>
<span class="fc" id="L267">					}</span>
<span class="fc" id="L268">					Map&lt;String, List&lt;URI&gt;&gt; links = product.getLinks();</span>
<span class="fc" id="L269">					for (Iterator&lt;String&gt; relIter = links.keySet().iterator(); relIter</span>
<span class="fc bfc" id="L270" title="All 2 branches covered.">							.hasNext();) {</span>
<span class="fc" id="L271">						String relation = relIter.next();</span>
<span class="fc" id="L272">						for (Iterator&lt;URI&gt; uriIter = links.get(relation)</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">								.iterator(); uriIter.hasNext();) {</span>
<span class="fc" id="L274">							URI href = uriIter.next();</span>
<span class="fc" id="L275">							handler.onLink(product.getId(), relation, href);</span>
<span class="fc" id="L276">						}</span>
<span class="fc" id="L277">					}</span>
<span class="fc" id="L278">					Map&lt;String, Content&gt; contents = product.getContents();</span>
<span class="fc" id="L279">					for (Iterator&lt;String&gt; pathIter = contents.keySet()</span>
<span class="fc bfc" id="L280" title="All 2 branches covered.">							.iterator(); pathIter.hasNext();) {</span>
<span class="fc" id="L281">						String path = pathIter.next();</span>
<span class="fc" id="L282">						handler.onContent(product.getId(), path,</span>
<span class="fc" id="L283">								contents.get(path));</span>
<span class="fc" id="L284">					}</span>
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">					if (product.getSignature() != null)</span>
<span class="fc" id="L286">						handler.onSignature(product.getId(),</span>
<span class="fc" id="L287">								product.getSignature());</span>
<span class="fc" id="L288">					handler.onEndProduct(product.getId());</span>
<span class="fc" id="L289">				}</span>
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">			} else if (result.getType() == SearchMethod.PRODUCTS_SUMMARY) {</span>
<span class="fc" id="L291">				ProductsSummaryQuery psQuery = (ProductsSummaryQuery) result;</span>
<span class="fc" id="L292">				List&lt;ProductSummary&gt; summaries = psQuery.getResult();</span>
<span class="fc" id="L293">				for (Iterator&lt;ProductSummary&gt; summaryIter = summaries</span>
<span class="fc bfc" id="L294" title="All 2 branches covered.">						.iterator(); summaryIter.hasNext();) {</span>
<span class="fc" id="L295">					writer.write(getProductSummaryXmlString(summaryIter.next()));</span>
				}
			}

<span class="fc" id="L299">			writer.write(&quot;&lt;/&quot; + RESULT_ELEMENT + &quot;&gt;&quot;);</span>
<span class="fc" id="L300">		}</span>
<span class="fc" id="L301">		writer.write(&quot;&lt;/&quot; + RESPONSE_ELEMENT + &quot;&gt;&quot;);</span>
<span class="fc" id="L302">		writer.flush();</span>
<span class="fc" id="L303">	}</span>

	/**
	 * Private  helper method to convert query elements into XML
	 * @param query
	 * 		the query element to convert to xml
	 * @return an xml string representing the query object
	 */
	private static String getQueryXMLString(SearchQuery query) {
<span class="fc" id="L312">		StringBuffer queryXmlString = new StringBuffer();</span>
<span class="fc" id="L313">		queryXmlString.append(&quot;&lt;&quot; + QUERY_ELEMENT);</span>
<span class="fc" id="L314">		queryXmlString.append(&quot; &quot; + METHOD_ATTRIBUTE + &quot;=\&quot;&quot;);</span>
<span class="fc" id="L315">		queryXmlString.append(query.getType().getXmlMethodName());</span>
<span class="fc" id="L316">		queryXmlString.append(&quot;\&quot;&quot;);</span>
<span class="fc" id="L317">		ProductIndexQuery prodIndexQuery = query.getProductIndexQuery();</span>
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">		if (prodIndexQuery.getEventSource() != null)</span>
<span class="fc" id="L319">			queryXmlString.append(&quot; &quot; + EVENT_SOURCE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L320">					+ prodIndexQuery.getEventSource() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">		if (prodIndexQuery.getEventSourceCode() != null)</span>
<span class="fc" id="L322">			queryXmlString.append(&quot; &quot; + EVENT_SOURCE_CODE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L323">					+ prodIndexQuery.getEventSourceCode() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">		if (prodIndexQuery.getMinEventTime() != null)</span>
<span class="fc" id="L325">			queryXmlString.append(&quot; &quot; + MIN_EVENT_TIME_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L326">					+ XmlUtils.formatDate(prodIndexQuery.getMinEventTime())</span>
					+ &quot;\&quot;&quot;);
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">		if (prodIndexQuery.getMaxEventTime() != null)</span>
<span class="fc" id="L329">			queryXmlString.append(&quot; &quot; + MAX_EVENT_TIME_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L330">					+ XmlUtils.formatDate(prodIndexQuery.getMaxEventTime())</span>
					+ &quot;\&quot;&quot;);
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">		if (prodIndexQuery.getMinEventLatitude() != null)</span>
<span class="fc" id="L333">			queryXmlString.append(&quot; &quot; + MIN_EVENT_LATITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L334">					+ prodIndexQuery.getMinEventLatitude() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L335" title="1 of 2 branches missed.">		if (prodIndexQuery.getMaxEventLatitude() != null)</span>
<span class="fc" id="L336">			queryXmlString.append(&quot; &quot; + MAX_EVENT_LATITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L337">					+ prodIndexQuery.getMaxEventLatitude() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">		if (prodIndexQuery.getMinEventLongitude() != null)</span>
<span class="fc" id="L339">			queryXmlString.append(&quot; &quot; + MIN_EVENT_LONGITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L340">					+ prodIndexQuery.getMinEventLongitude() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">		if (prodIndexQuery.getMaxEventLongitude() != null)</span>
<span class="fc" id="L342">			queryXmlString.append(&quot; &quot; + MAX_EVENT_LONGITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L343">					+ prodIndexQuery.getMaxEventLongitude() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L344" title="1 of 2 branches missed.">		if (prodIndexQuery.getMinEventDepth() != null)</span>
<span class="fc" id="L345">			queryXmlString.append(&quot; &quot; + MIN_EVENT_DEPTH_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L346">					+ prodIndexQuery.getMinEventDepth() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L347" title="1 of 2 branches missed.">		if (prodIndexQuery.getMaxEventDepth() != null)</span>
<span class="fc" id="L348">			queryXmlString.append(&quot; &quot; + MAX_EVENT_DEPTH_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L349">					+ prodIndexQuery.getMaxEventDepth() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">		if (prodIndexQuery.getMinEventMagnitude() != null)</span>
<span class="fc" id="L351">			queryXmlString.append(&quot; &quot; + MIN_EVENT_MAGNITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L352">					+ prodIndexQuery.getMinEventMagnitude() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">		if (prodIndexQuery.getMaxEventMagnitude() != null)</span>
<span class="fc" id="L354">			queryXmlString.append(&quot; &quot; + MAX_EVENT_MAGNITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L355">					+ prodIndexQuery.getMaxEventMagnitude() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">		if (prodIndexQuery.getMinProductUpdateTime() != null)</span>
<span class="fc" id="L357">			queryXmlString.append(&quot; &quot;</span>
					+ MIN_PRODUCT_UPDATE_TIME_ATTRIBUTE
					+ &quot;=\&quot;&quot;
<span class="fc" id="L360">					+ XmlUtils.formatDate(prodIndexQuery</span>
<span class="fc" id="L361">							.getMinProductUpdateTime()) + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L362" title="1 of 2 branches missed.">		if (prodIndexQuery.getMaxProductUpdateTime() != null)</span>
<span class="fc" id="L363">			queryXmlString.append(&quot; &quot;</span>
					+ MAX_PRODUCT_UPDATE_TIME_ATTRIBUTE
					+ &quot;=\&quot;&quot;
<span class="fc" id="L366">					+ XmlUtils.formatDate(prodIndexQuery</span>
<span class="fc" id="L367">							.getMaxProductUpdateTime()) + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">		if (prodIndexQuery.getProductSource() != null)</span>
<span class="fc" id="L369">			queryXmlString.append(&quot; &quot; + PRODUCT_SOURCE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L370">					+ prodIndexQuery.getProductSource() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">		if (prodIndexQuery.getProductType() != null)</span>
<span class="fc" id="L372">			queryXmlString.append(&quot; &quot; + PRODUCT_TYPE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L373">					+ prodIndexQuery.getProductType() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">		if (prodIndexQuery.getProductCode() != null)</span>
<span class="fc" id="L375">			queryXmlString.append(&quot; &quot; + PRODUCT_CODE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L376">					+ prodIndexQuery.getProductCode() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">		if (prodIndexQuery.getProductVersion() != null)</span>
<span class="fc" id="L378">			queryXmlString.append(&quot; &quot; + PRODUCT_VERSION_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L379">					+ prodIndexQuery.getProductVersion() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L380" title="1 of 2 branches missed.">		if (prodIndexQuery.getProductStatus() != null)</span>
<span class="fc" id="L381">			queryXmlString.append(&quot; &quot; + PRODUCT_STATUS_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L382">					+ prodIndexQuery.getProductStatus() + &quot;\&quot;&quot;);</span>

<span class="fc" id="L384">		queryXmlString.append(&quot;&gt;&quot;);</span>

<span class="fc" id="L386">		Iterator&lt;ProductId&gt; ids = prodIndexQuery.getProductIds().iterator();</span>
<span class="fc bfc" id="L387" title="All 2 branches covered.">		while (ids.hasNext()) {</span>
<span class="fc" id="L388">			queryXmlString.append(&quot;&lt;&quot; + PRODUCT_SUMMARY_ELEMENT);</span>
<span class="fc" id="L389">			queryXmlString.append(&quot; &quot; + ID_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L390">					+ ids.next().toString() + &quot;\&quot;&quot;);</span>
<span class="fc" id="L391">			queryXmlString.append(&quot; /&gt;&quot;);</span>
		}

<span class="fc" id="L394">		queryXmlString.append(&quot;&lt;/&quot; + QUERY_ELEMENT + &quot;&gt;&quot;);</span>

<span class="fc" id="L396">		return queryXmlString.toString();</span>
	}

	/**
	 * Private  helper method to convert product summary elements into XML
	 * @param summary
	 * 		the product summary element to convert to xml
	 * @return an xml string representing the product summary object
	 */
	private static String getProductSummaryXmlString(ProductSummary summary) {
<span class="fc" id="L406">		String summaryXmlString = &quot;&quot;;</span>
<span class="fc" id="L407">		summaryXmlString += &quot;&lt;&quot; + PRODUCT_SUMMARY_ELEMENT;</span>
<span class="pc bpc" id="L408" title="1 of 2 branches missed.">		if (summary.getId() != null)</span>
<span class="fc" id="L409">			summaryXmlString += &quot; &quot; + ID_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L410">					+ summary.getId().toString() + &quot;\&quot;&quot;;</span>
<span class="pc bpc" id="L411" title="1 of 2 branches missed.">		if (summary.getId().getUpdateTime() != null)</span>
<span class="fc" id="L412">			summaryXmlString += &quot; &quot; + UPDATE_TIME_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L413">					+ XmlUtils.formatDate(summary.getId().getUpdateTime())</span>
					+ &quot;\&quot;&quot;;
<span class="pc bpc" id="L415" title="1 of 2 branches missed.">		if (summary.getStatus() != null)</span>
<span class="fc" id="L416">			summaryXmlString += &quot; &quot; + STATUS_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L417">					+ summary.getStatus() + &quot;\&quot;&quot;;</span>
<span class="pc bpc" id="L418" title="1 of 2 branches missed.">		if (summary.getSource() != null)</span>
<span class="fc" id="L419">			summaryXmlString += &quot; &quot; + SOURCE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L420">					+ summary.getSource() + &quot;\&quot;&quot;;</span>
<span class="pc bpc" id="L421" title="1 of 2 branches missed.">		if (summary.getCode() != null)</span>
<span class="fc" id="L422">			summaryXmlString += &quot; &quot; + SOURCE_CODE_ATTRIBUTE + &quot;=\&quot;&quot; +</span>
<span class="fc" id="L423">					summary.getCode() + &quot;\&quot;&quot;;</span>
<span class="fc bfc" id="L424" title="All 2 branches covered.">		if (summary.getEventTime() != null)</span>
<span class="fc" id="L425">			summaryXmlString += &quot; &quot; + TIME_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L426">					+ XmlUtils.formatDate(summary.getEventTime()) + &quot;\&quot;&quot;;</span>
<span class="fc bfc" id="L427" title="All 2 branches covered.">		if (summary.getEventLatitude() != null)</span>
<span class="fc" id="L428">			summaryXmlString += &quot; &quot; + LATITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L429">					+ summary.getEventLatitude().toString() + &quot;\&quot;&quot;;</span>
<span class="fc bfc" id="L430" title="All 2 branches covered.">		if (summary.getEventLongitude() != null)</span>
<span class="fc" id="L431">			summaryXmlString += &quot; &quot; + LONGITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L432">					+ summary.getEventLongitude().toString() + &quot;\&quot;&quot;;</span>
<span class="fc bfc" id="L433" title="All 2 branches covered.">		if (summary.getEventDepth() != null)</span>
<span class="fc" id="L434">			summaryXmlString += &quot; &quot; + DEPTH_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L435">					+ summary.getEventDepth().toString() + &quot;\&quot;&quot;;</span>
<span class="fc bfc" id="L436" title="All 2 branches covered.">		if (summary.getEventMagnitude() != null)</span>
<span class="fc" id="L437">			summaryXmlString += &quot; &quot; + MAGNITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L438">					+ summary.getEventMagnitude().toString() + &quot;\&quot;&quot;;</span>
<span class="fc bfc" id="L439" title="All 2 branches covered.">		if (summary.getVersion() != null)</span>
<span class="fc" id="L440">			summaryXmlString += &quot; &quot; + VERSION_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L441">					+ summary.getVersion() + &quot;\&quot;&quot;;</span>
<span class="fc" id="L442">		summaryXmlString += &quot; &quot; + PREFERRED_WEIGHT_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L443">				+ summary.getPreferredWeight() + &quot;\&quot;&quot;;</span>
<span class="fc" id="L444">		summaryXmlString += &quot;&gt;&quot;;</span>

<span class="fc" id="L446">		Map&lt;String, String&gt; properties = summary.getProperties();</span>
<span class="fc" id="L447">		for (Iterator&lt;String&gt; propIter = properties.keySet().iterator(); propIter</span>
<span class="fc bfc" id="L448" title="All 2 branches covered.">				.hasNext();) {</span>
<span class="fc" id="L449">			String name = propIter.next();</span>
<span class="fc" id="L450">			String value = properties.get(name);</span>
<span class="fc" id="L451">			summaryXmlString += &quot;&lt;product:&quot;</span>
					+ XmlProductHandler.PROPERTY_ELEMENT;
<span class="fc" id="L453">			summaryXmlString += &quot; &quot; + XmlProductHandler.PROPERTY_ATTRIBUTE_NAME</span>
					+ &quot;=\&quot;&quot; + name + &quot;\&quot;&quot;;
<span class="fc" id="L455">			summaryXmlString += &quot; &quot;</span>
					+ XmlProductHandler.PROPERTY_ATTRIBUTE_VALUE + &quot;=\&quot;&quot;
					+ value + &quot;\&quot;&quot;;
<span class="fc" id="L458">			summaryXmlString += &quot; /&gt;&quot;;</span>
<span class="fc" id="L459">		}</span>

<span class="fc" id="L461">		Map&lt;String, List&lt;URI&gt;&gt; links = summary.getLinks();</span>
<span class="fc" id="L462">		for (Iterator&lt;String&gt; linkIter = links.keySet().iterator(); linkIter</span>
<span class="fc bfc" id="L463" title="All 2 branches covered.">				.hasNext();) {</span>
<span class="fc" id="L464">			String relation = linkIter.next();</span>
<span class="fc" id="L465">			for (Iterator&lt;URI&gt; uriIter = links.get(relation).iterator(); uriIter</span>
<span class="fc bfc" id="L466" title="All 2 branches covered.">					.hasNext();) {</span>
<span class="fc" id="L467">				URI href = uriIter.next();</span>
<span class="fc" id="L468">				summaryXmlString += &quot;&lt;product:&quot;</span>
						+ XmlProductHandler.LINK_ELEMENT;
<span class="fc" id="L470">				summaryXmlString += &quot; &quot;</span>
						+ XmlProductHandler.LINK_ATTRIBUTE_RELATION + &quot;=\&quot;&quot;
						+ relation + &quot;\&quot;&quot;;
<span class="fc" id="L473">				summaryXmlString += &quot; &quot; + XmlProductHandler.LINK_ATTRIBUTE_HREF</span>
						+ &quot;=\&quot;&quot; + href + &quot;\&quot;&quot;;
<span class="fc" id="L475">				summaryXmlString += &quot; /&gt;&quot;;</span>
<span class="fc" id="L476">			}</span>
<span class="fc" id="L477">		}</span>

<span class="fc" id="L479">		summaryXmlString += &quot;&lt;/&quot; + PRODUCT_SUMMARY_ELEMENT + &quot;&gt;&quot;;</span>
<span class="fc" id="L480">		return summaryXmlString;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>