<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArchivePolicy.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.indexer</a> &gt; <span class="el_source">ArchivePolicy.java</span></div><h1>ArchivePolicy.java</h1><pre class="source lang-java linenums">package gov.usgs.earthquake.indexer;

import gov.usgs.earthquake.distribution.ConfigurationException;
import gov.usgs.earthquake.util.ISO8601;
import gov.usgs.util.Config;
import gov.usgs.util.DefaultConfigurable;

import java.math.BigDecimal;
import java.util.Date;
import java.util.logging.Logger;

/**
 * An ArchivePolicy sets a policy for the indexer to to clean up its
 * ProductIndex. The policy is created by configuration parameters and generates
 * a ProductIndexQuery. Any product/event matching the product index query is
 * archived. Generally, archiving means the data for that product/event is
 * removed from the index as well as the storage. Upon archiving, an
 * EVENT_ARCHIVED type of IndexerEvent is sent to interested listeners.
 * 
 * All archive policies run in their own thread (one thread separate from
 * indexing for all archive policies, not one each) and execute at configured
 * intervals.
 * 
 * @author emartinez
 * 
 */
public class ArchivePolicy extends DefaultConfigurable {

<span class="fc" id="L29">	private static final Logger LOGGER = Logger.getLogger(ArchivePolicy.class</span>
<span class="fc" id="L30">			.getName());</span>

	// --------------------------------------------------------------------
	// Names of configurable parameters
	// --------------------------------------------------------------------

	/** @deprecated */
	public static final String ARCHIVE_MIN_AGE_PROPERTY = &quot;minAge&quot;;
	/** @deprecated */
	public static final String ARCHIVE_MAX_AGE_PROPERTY = &quot;maxAge&quot;;

	public static final String ARCHIVE_MIN_EVENT_AGE_PROPERTY = &quot;minEventAge&quot;;
	public static final String ARCHIVE_MAX_EVENT_AGE_PROPERTY = &quot;maxEventAge&quot;;

	public static final String ARCHIVE_MIN_EVENT_TIME_PROPERTY = &quot;minEventTime&quot;;
	public static final String ARCHIVE_MAX_EVENT_TIME_PROPERTY = &quot;maxEventTime&quot;;

	public static final String ARCHIVE_MIN_MAG_PROPERTY = &quot;minMag&quot;;
	public static final String ARCHIVE_MAX_MAG_PROPERTY = &quot;maxMag&quot;;

	public static final String ARCHIVE_MIN_LAT_PROPERTY = &quot;minLat&quot;;
	public static final String ARCHIVE_MAX_LAT_PROPERTY = &quot;maxLat&quot;;

	public static final String ARCHIVE_MIN_LNG_PROPERTY = &quot;minLng&quot;;
	public static final String ARCHIVE_MAX_LNG_PROPERTY = &quot;maxLng&quot;;

	public static final String ARCHIVE_MIN_DEPTH_PROPERTY = &quot;minDepth&quot;;
	public static final String ARCHIVE_MAX_DEPTH_PROPERTY = &quot;maxDepth&quot;;

	public static final String ARCHIVE_EVENT_SOURCE_PROPERTY = &quot;eventSource&quot;;

	// --------------------------------------------------------------------
	// Configured parameters.
	// --------------------------------------------------------------------

	/** @deprecated */
<span class="fc" id="L66">	protected Long minAge = null;</span>
	/** @deprecated */
<span class="fc" id="L68">	protected Long maxAge = null;</span>

<span class="fc" id="L70">	protected Long minEventAge = null;</span>
<span class="fc" id="L71">	protected Long maxEventAge = null;</span>

<span class="fc" id="L73">	protected Long minEventTime = null;</span>
<span class="fc" id="L74">	protected Long maxEventTime = null;</span>

<span class="fc" id="L76">	protected BigDecimal minMag = null;</span>
<span class="fc" id="L77">	protected BigDecimal maxMag = null;</span>

<span class="fc" id="L79">	protected BigDecimal minLat = null;</span>
<span class="fc" id="L80">	protected BigDecimal maxLat = null;</span>

<span class="fc" id="L82">	protected BigDecimal minLng = null;</span>
<span class="fc" id="L83">	protected BigDecimal maxLng = null;</span>

<span class="fc" id="L85">	protected BigDecimal minDepth = null;</span>
<span class="fc" id="L86">	protected BigDecimal maxDepth = null;</span>

<span class="fc" id="L88">	protected String eventSource = null;</span>

<span class="fc" id="L90">	public ArchivePolicy() {</span>
		// Default constructor
<span class="fc" id="L92">	}</span>

	@Override
	public void configure(Config config) throws Exception {
<span class="fc" id="L96">		minEventAge = parseLong(config, ARCHIVE_MIN_EVENT_AGE_PROPERTY);</span>
<span class="fc" id="L97">		maxEventAge = parseLong(config, ARCHIVE_MAX_EVENT_AGE_PROPERTY);</span>

<span class="fc" id="L99">		minEventTime = parseDateOrLong(config, ARCHIVE_MIN_EVENT_TIME_PROPERTY);</span>
<span class="fc" id="L100">		maxEventTime = parseDateOrLong(config, ARCHIVE_MAX_EVENT_TIME_PROPERTY);</span>

<span class="fc" id="L102">		minAge = parseLong(config, ARCHIVE_MIN_AGE_PROPERTY);</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">		if (minAge != null) {</span>
<span class="fc" id="L104">			LOGGER.config(&quot;Use of minAge property is deprecated.&quot;);</span>
		}
<span class="fc" id="L106">		maxAge = parseLong(config, ARCHIVE_MAX_AGE_PROPERTY);</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">		if (maxAge != null) {</span>
<span class="fc" id="L108">			LOGGER.config(&quot;Use of maxAge property is deprecated.&quot;);</span>
		}

<span class="pc bpc" id="L111" title="1 of 4 branches missed.">		if (minEventAge != null &amp;&amp; maxEventTime != null) {</span>
<span class="nc" id="L112">			LOGGER.config(&quot;Both minEventAge and maxEventTime were specified. &quot;</span>
					+ &quot;Ignoring minEventAge. Only maxEventTime will be used.&quot;);
		}
<span class="pc bpc" id="L115" title="1 of 4 branches missed.">		if (maxEventAge != null &amp;&amp; minEventTime != null) {</span>
<span class="nc" id="L116">			LOGGER.config(&quot;Both maxEventAge and minEventTime were specified. &quot;</span>
					+ &quot;Ignoring maxEventAge. Only minEventTime will be used.&quot;);
		}

<span class="pc bpc" id="L120" title="2 of 12 branches missed.">		if ((minAge != null || maxAge != null)</span>
				&amp;&amp; (minEventAge != null || maxEventAge != null
						|| minEventTime != null || maxEventTime != null)) {

<span class="fc" id="L124">			ConfigurationException ce = new ConfigurationException(</span>
					&quot;Configuration mismatch. Can not specify both &quot;
							+ &quot;minAge/maxAge (legacy) properties as well as &quot;
							+ &quot;minEventAge/maxEventAge or minEventTime/maxEventTime.&quot;);

<span class="fc" id="L129">			ce.fillInStackTrace();</span>
<span class="fc" id="L130">			throw ce;</span>
		}

<span class="fc bfc" id="L133" title="All 4 branches covered.">		if ((minEventAge != null &amp;&amp; maxEventAge != null)</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">				&amp;&amp; (minEventAge &gt; maxEventAge)) {</span>

<span class="fc" id="L136">			ConfigurationException ce = new ConfigurationException(</span>
					&quot;Configuration mismatch. minEventAge &quot;
							+ &quot;greater than maxEventAge.&quot;);
<span class="fc" id="L139">			ce.fillInStackTrace();</span>
<span class="fc" id="L140">			throw ce;</span>
		}

<span class="pc bpc" id="L143" title="1 of 4 branches missed.">		if ((minEventTime != null &amp;&amp; maxEventTime != null)</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">				&amp;&amp; (minEventTime &gt; maxEventTime)) {</span>

<span class="fc" id="L146">			ConfigurationException ce = new ConfigurationException(</span>
					&quot;Configuration mismatch. minEventTime &quot;
							+ &quot;greater than maxEventTime.&quot;);
<span class="fc" id="L149">			ce.fillInStackTrace();</span>
<span class="fc" id="L150">			throw ce;</span>
		}

<span class="fc" id="L153">		minMag = parseBigDecimal(config, ARCHIVE_MIN_MAG_PROPERTY);</span>
<span class="fc" id="L154">		maxMag = parseBigDecimal(config, ARCHIVE_MAX_MAG_PROPERTY);</span>
<span class="fc" id="L155">		minLat = parseBigDecimal(config, ARCHIVE_MIN_LAT_PROPERTY);</span>
<span class="fc" id="L156">		maxLat = parseBigDecimal(config, ARCHIVE_MAX_LAT_PROPERTY);</span>
<span class="fc" id="L157">		minLng = parseBigDecimal(config, ARCHIVE_MIN_LNG_PROPERTY);</span>
<span class="fc" id="L158">		maxLng = parseBigDecimal(config, ARCHIVE_MAX_LNG_PROPERTY);</span>
<span class="fc" id="L159">		minDepth = parseBigDecimal(config, ARCHIVE_MIN_DEPTH_PROPERTY);</span>
<span class="fc" id="L160">		maxDepth = parseBigDecimal(config, ARCHIVE_MAX_DEPTH_PROPERTY);</span>
<span class="fc" id="L161">		eventSource = config.getProperty(ARCHIVE_EVENT_SOURCE_PROPERTY);</span>
<span class="fc" id="L162">	}</span>

	@Override
	public void shutdown() throws Exception {
		// Nothing to do
<span class="nc" id="L167">	}</span>

	@Override
	public void startup() throws Exception {
		// Nothing to do
<span class="nc" id="L172">	}</span>

	public ProductIndexQuery getIndexQuery() {
<span class="fc" id="L175">		ProductIndexQuery productIndexQuery = new ProductIndexQuery();</span>
<span class="fc" id="L176">		Date now = new Date();</span>

<span class="fc bfc" id="L178" title="All 2 branches covered.">		if (minAge != null) {</span>
			// min age corresponds to minimum event time
<span class="fc" id="L180">			productIndexQuery.setMinEventTime(new Date(now.getTime()</span>
<span class="fc" id="L181">					- minAge.longValue()));</span>
		}
<span class="fc bfc" id="L183" title="All 2 branches covered.">		if (maxAge != null) {</span>
			// max age corresponds to maximum event time
<span class="fc" id="L185">			productIndexQuery.setMaxEventTime(new Date(now.getTime()</span>
<span class="fc" id="L186">					- maxAge.longValue()));</span>
		}

		/*-
		 Epoch                                                            Now
		   |------------------- maxAge &lt;---------------------------------- |
		   |                       |                                       |
		   |                       |                minAge &lt;---------------|
		   |                       |                   |                   |
		   |-----------------------|-------------------|-------------------|
		   |                       |                   |
		   |------------------&gt; minTime                |
		   |                                           |
		   |--------------------------------------&gt; maxTime
		   
		 Simple Example (not to scale)
		 
		   0 (Epoch)                                              (Now) 100,000
		   |------------------- maxAge &lt;--- (10,000) --------------------- |
		   |                       |                                       |
		   |                       |                minAge &lt;--- (1,000) ---|
		   |                       |                   |                   |
		   |-------------------- 90,000 ************ 99,000 ---------------|
		   |                       |                   |
		   |----- (90,000) ---&gt; minTime                |
		   |                                           |
		   |------------------------- (99,000) ---&gt; maxTime
		   
		   Events occurring in the *** time span will match the query and be
		   archived.
		 */

<span class="fc bfc" id="L218" title="All 2 branches covered.">		if (maxEventAge != null) {</span>
<span class="fc" id="L219">			productIndexQuery.setMinEventTime(new Date(now.getTime()</span>
<span class="fc" id="L220">					- maxEventAge.longValue()));</span>
		}
<span class="fc bfc" id="L222" title="All 2 branches covered.">		if (minEventAge != null) {</span>
<span class="fc" id="L223">			productIndexQuery.setMaxEventTime(new Date(now.getTime()</span>
<span class="fc" id="L224">					- minEventAge.longValue()));</span>
		}

<span class="pc bpc" id="L227" title="1 of 2 branches missed.">		if (minEventTime != null) {</span>
<span class="nc" id="L228">			productIndexQuery</span>
<span class="nc" id="L229">					.setMinEventTime(new Date(minEventTime.longValue()));</span>
		}
<span class="fc bfc" id="L231" title="All 2 branches covered.">		if (maxEventTime != null) {</span>
<span class="fc" id="L232">			productIndexQuery</span>
<span class="fc" id="L233">					.setMaxEventTime(new Date(maxEventTime.longValue()));</span>
		}

<span class="fc" id="L236">		productIndexQuery.setMinEventMagnitude(minMag);</span>
<span class="fc" id="L237">		productIndexQuery.setMaxEventMagnitude(maxMag);</span>
<span class="fc" id="L238">		productIndexQuery.setMinEventLatitude(minLat);</span>
<span class="fc" id="L239">		productIndexQuery.setMaxEventLatitude(maxLat);</span>
<span class="fc" id="L240">		productIndexQuery.setMinEventLongitude(minLng);</span>
<span class="fc" id="L241">		productIndexQuery.setMaxEventLongitude(maxLng);</span>
<span class="fc" id="L242">		productIndexQuery.setMinEventDepth(minDepth);</span>
<span class="fc" id="L243">		productIndexQuery.setMaxEventDepth(maxDepth);</span>
<span class="fc" id="L244">		productIndexQuery.setEventSource(eventSource);</span>

		// this archive policy is only for events, only remove events based on
		// their preferred properties
<span class="fc" id="L248">		productIndexQuery</span>
<span class="fc" id="L249">				.setEventSearchType(ProductIndexQuery.SEARCH_EVENT_PREFERRED);</span>
		
<span class="fc" id="L251">		productIndexQuery.setResultType(ProductIndexQuery.RESULT_TYPE_ALL);</span>
		
<span class="fc" id="L253">		return productIndexQuery;</span>
	}

	public boolean isValidPolicy() {
		// Not valid if using both old and new configuration methods
<span class="pc bpc" id="L258" title="6 of 8 branches missed.">		boolean valid = !((minAge != null || maxAge != null) &amp;&amp; (minEventAge != null || maxEventAge != null));</span>

<span class="pc bpc" id="L260" title="28 of 32 branches missed.">		return valid</span>
				&amp;&amp; (minAge != null || maxAge != null || minEventAge != null
						|| maxEventAge != null || minEventTime != null
						|| maxEventTime != null || minMag != null
						|| maxMag != null || minLat != null || maxLat != null
						|| minLng != null || maxLng != null || minDepth != null
						|| maxDepth != null || eventSource != null);
	}

	protected BigDecimal parseBigDecimal(Config config, String name) {
<span class="fc" id="L270">		BigDecimal property = null;</span>
		try {
<span class="fc" id="L272">			String buffer = config.getProperty(name);</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">			if (buffer != null) {</span>
<span class="nc" id="L274">				property = new BigDecimal(buffer);</span>
			}
<span class="nc" id="L276">		} catch (NumberFormatException npx) {</span>
<span class="nc" id="L277">			property = null;</span>
<span class="fc" id="L278">		}</span>
<span class="fc" id="L279">		return property;</span>
	}

	protected Long parseDateOrLong(Config config, String name) {
<span class="fc" id="L283">		Long property = null;</span>
		try {
<span class="fc" id="L285">			String buffer = config.getProperty(name);</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">			if (buffer != null) {</span>
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">				if (buffer.indexOf(&quot;T&quot;) != -1) {</span>
					// try parsing as date
<span class="nc" id="L289">					Date date = ISO8601.parse(buffer);</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">					if (date != null) {</span>
<span class="nc" id="L291">						property = date.getTime();</span>
					}
<span class="nc" id="L293">				} else {</span>
<span class="fc" id="L294">					property = Long.valueOf(buffer);</span>
				}
			}
<span class="nc" id="L297">		} catch (NumberFormatException npx) {</span>
<span class="nc" id="L298">			property = null;</span>
<span class="fc" id="L299">		}</span>
<span class="fc" id="L300">		return property;</span>
	}

	protected Long parseLong(Config config, String name) {
<span class="fc" id="L304">		Long property = null;</span>
		try {
<span class="fc" id="L306">			String buffer = config.getProperty(name);</span>
<span class="fc bfc" id="L307" title="All 2 branches covered.">			if (buffer != null) {</span>
<span class="fc" id="L308">				property = Long.valueOf(buffer);</span>
			}
<span class="nc" id="L310">		} catch (NumberFormatException npx) {</span>
<span class="nc" id="L311">			property = null;</span>
<span class="fc" id="L312">		}</span>
<span class="fc" id="L313">		return property;</span>
	}

	/** @deprecated */
	public Long getMinAge() {
<span class="nc" id="L318">		return minAge;</span>
	}

	/** @deprecated */
	public void setMinAge(Long minAge) {
<span class="nc" id="L323">		this.minAge = minAge;</span>
<span class="nc" id="L324">	}</span>

	/** @deprecated */
	public Long getMaxAge() {
<span class="nc" id="L328">		return maxAge;</span>
	}

	/** @deprecated */
	public void setMaxAge(Long maxAge) {
<span class="nc" id="L333">		this.maxAge = maxAge;</span>
<span class="nc" id="L334">	}</span>

	public Long getMinEventAge() {
<span class="nc" id="L337">		return minEventAge;</span>
	}

	public void setMinEventAge(Long minEventAge) {
<span class="nc" id="L341">		this.minEventAge = minEventAge;</span>
<span class="nc" id="L342">	}</span>

	public Long getMaxEventAge() {
<span class="nc" id="L345">		return maxEventAge;</span>
	}

	public void setMaxEventAge(Long maxEventAge) {
<span class="nc" id="L349">		this.maxEventAge = maxEventAge;</span>
<span class="nc" id="L350">	}</span>

	public Long getMinEventTime() {
<span class="nc" id="L353">		return minEventTime;</span>
	}

	public void setMinEventTime(Long minEventTime) {
<span class="nc" id="L357">		this.minEventTime = minEventTime;</span>
<span class="nc" id="L358">	}</span>

	public Long getMaxEventTime() {
<span class="nc" id="L361">		return maxEventTime;</span>
	}

	public void setMaxEventTime(Long maxEventTime) {
<span class="nc" id="L365">		this.maxEventTime = maxEventTime;</span>
<span class="nc" id="L366">	}</span>

	public BigDecimal getMinMag() {
<span class="nc" id="L369">		return minMag;</span>
	}

	public void setMinMag(BigDecimal minMag) {
<span class="nc" id="L373">		this.minMag = minMag;</span>
<span class="nc" id="L374">	}</span>

	public BigDecimal getMaxMag() {
<span class="nc" id="L377">		return maxMag;</span>
	}

	public void setMaxMag(BigDecimal maxMag) {
<span class="nc" id="L381">		this.maxMag = maxMag;</span>
<span class="nc" id="L382">	}</span>

	public BigDecimal getMinLat() {
<span class="nc" id="L385">		return minLat;</span>
	}

	public void setMinLat(BigDecimal minLat) {
<span class="nc" id="L389">		this.minLat = minLat;</span>
<span class="nc" id="L390">	}</span>

	public BigDecimal getMaxLat() {
<span class="nc" id="L393">		return maxLat;</span>
	}

	public void setMaxLat(BigDecimal maxLat) {
<span class="nc" id="L397">		this.maxLat = maxLat;</span>
<span class="nc" id="L398">	}</span>

	public BigDecimal getMinLng() {
<span class="nc" id="L401">		return minLng;</span>
	}

	public void setMinLng(BigDecimal minLng) {
<span class="nc" id="L405">		this.minLng = minLng;</span>
<span class="nc" id="L406">	}</span>

	public BigDecimal getMaxLng() {
<span class="nc" id="L409">		return maxLng;</span>
	}

	public void setMaxLng(BigDecimal maxLng) {
<span class="nc" id="L413">		this.maxLng = maxLng;</span>
<span class="nc" id="L414">	}</span>

	public BigDecimal getMinDepth() {
<span class="nc" id="L417">		return minDepth;</span>
	}

	public void setMinDepth(BigDecimal minDepth) {
<span class="nc" id="L421">		this.minDepth = minDepth;</span>
<span class="nc" id="L422">	}</span>

	public BigDecimal getMaxDepth() {
<span class="nc" id="L425">		return maxDepth;</span>
	}

	public void setMaxDepth(BigDecimal maxDepth) {
<span class="nc" id="L429">		this.maxDepth = maxDepth;</span>
<span class="nc" id="L430">	}</span>

	public String getEventSource() {
<span class="nc" id="L433">		return eventSource;</span>
	}

	public void setEventSource(String eventSource) {
<span class="fc" id="L437">		this.eventSource = eventSource;</span>
<span class="fc" id="L438">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>