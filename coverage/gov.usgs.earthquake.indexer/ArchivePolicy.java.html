<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArchivePolicy.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.indexer</a> &gt; <span class="el_source">ArchivePolicy.java</span></div><h1>ArchivePolicy.java</h1><pre class="source lang-java linenums">package gov.usgs.earthquake.indexer;

import gov.usgs.earthquake.distribution.ConfigurationException;
import gov.usgs.earthquake.util.ISO8601;
import gov.usgs.util.Config;
import gov.usgs.util.DefaultConfigurable;

import java.math.BigDecimal;
import java.util.Date;
import java.util.logging.Logger;

/**
 * A policy for the Indexer to clean up Events in its ProductIndex.
 *
 * The policy is created by configuration parameters and generates
 * a ProductIndexQuery. Any product/event matching the product index query is
 * archived. Generally, archiving means the data for that product/event is
 * removed from the index as well as the storage. Upon archiving, an
 * EVENT_ARCHIVED type of IndexerEvent is sent to interested listeners.
 * 
 * All archive policies run in their own thread (one thread separate from
 * indexing for all archive policies, not one each) and execute at configured
 * intervals.
 * 
 * @author emartinez
 * 
 */
public class ArchivePolicy extends DefaultConfigurable {

<span class="fc" id="L30">	private static final Logger LOGGER = Logger.getLogger(ArchivePolicy.class</span>
<span class="fc" id="L31">			.getName());</span>

	// --------------------------------------------------------------------
	// Names of configurable parameters
	// --------------------------------------------------------------------

	/** @deprecated */
	public static final String ARCHIVE_MIN_AGE_PROPERTY = &quot;minAge&quot;;
	/** @deprecated */
	public static final String ARCHIVE_MAX_AGE_PROPERTY = &quot;maxAge&quot;;

	public static final String ARCHIVE_MIN_EVENT_AGE_PROPERTY = &quot;minEventAge&quot;;
	public static final String ARCHIVE_MAX_EVENT_AGE_PROPERTY = &quot;maxEventAge&quot;;

	public static final String ARCHIVE_MIN_EVENT_TIME_PROPERTY = &quot;minEventTime&quot;;
	public static final String ARCHIVE_MAX_EVENT_TIME_PROPERTY = &quot;maxEventTime&quot;;

	public static final String ARCHIVE_MIN_MAG_PROPERTY = &quot;minMag&quot;;
	public static final String ARCHIVE_MAX_MAG_PROPERTY = &quot;maxMag&quot;;

	public static final String ARCHIVE_MIN_LAT_PROPERTY = &quot;minLat&quot;;
	public static final String ARCHIVE_MAX_LAT_PROPERTY = &quot;maxLat&quot;;

	public static final String ARCHIVE_MIN_LNG_PROPERTY = &quot;minLng&quot;;
	public static final String ARCHIVE_MAX_LNG_PROPERTY = &quot;maxLng&quot;;

	public static final String ARCHIVE_MIN_DEPTH_PROPERTY = &quot;minDepth&quot;;
	public static final String ARCHIVE_MAX_DEPTH_PROPERTY = &quot;maxDepth&quot;;

	public static final String ARCHIVE_EVENT_SOURCE_PROPERTY = &quot;eventSource&quot;;

	// --------------------------------------------------------------------
	// Configured parameters.
	// --------------------------------------------------------------------

	/** @deprecated */
<span class="fc" id="L67">	protected Long minAge = null;</span>
	/** @deprecated */
<span class="fc" id="L69">	protected Long maxAge = null;</span>

<span class="fc" id="L71">	protected Long minEventAge = null;</span>
<span class="fc" id="L72">	protected Long maxEventAge = null;</span>

<span class="fc" id="L74">	protected Long minEventTime = null;</span>
<span class="fc" id="L75">	protected Long maxEventTime = null;</span>

<span class="fc" id="L77">	protected BigDecimal minMag = null;</span>
<span class="fc" id="L78">	protected BigDecimal maxMag = null;</span>

<span class="fc" id="L80">	protected BigDecimal minLat = null;</span>
<span class="fc" id="L81">	protected BigDecimal maxLat = null;</span>

<span class="fc" id="L83">	protected BigDecimal minLng = null;</span>
<span class="fc" id="L84">	protected BigDecimal maxLng = null;</span>

<span class="fc" id="L86">	protected BigDecimal minDepth = null;</span>
<span class="fc" id="L87">	protected BigDecimal maxDepth = null;</span>

<span class="fc" id="L89">	protected String eventSource = null;</span>

<span class="fc" id="L91">	public ArchivePolicy() {</span>
		// Default constructor
<span class="fc" id="L93">	}</span>

	@Override
	public void configure(Config config) throws Exception {
<span class="fc" id="L97">		minEventAge = parseLong(config, ARCHIVE_MIN_EVENT_AGE_PROPERTY);</span>
<span class="fc" id="L98">		maxEventAge = parseLong(config, ARCHIVE_MAX_EVENT_AGE_PROPERTY);</span>

<span class="fc" id="L100">		minEventTime = parseDateOrLong(config, ARCHIVE_MIN_EVENT_TIME_PROPERTY);</span>
<span class="fc" id="L101">		maxEventTime = parseDateOrLong(config, ARCHIVE_MAX_EVENT_TIME_PROPERTY);</span>

<span class="fc" id="L103">		minAge = parseLong(config, ARCHIVE_MIN_AGE_PROPERTY);</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">		if (minAge != null) {</span>
<span class="fc" id="L105">			LOGGER.config(&quot;Use of minAge property is deprecated.&quot;);</span>
		}
<span class="fc" id="L107">		maxAge = parseLong(config, ARCHIVE_MAX_AGE_PROPERTY);</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">		if (maxAge != null) {</span>
<span class="fc" id="L109">			LOGGER.config(&quot;Use of maxAge property is deprecated.&quot;);</span>
		}

<span class="pc bpc" id="L112" title="1 of 4 branches missed.">		if (minEventAge != null &amp;&amp; maxEventTime != null) {</span>
<span class="nc" id="L113">			LOGGER.config(&quot;Both minEventAge and maxEventTime were specified. &quot;</span>
					+ &quot;Ignoring minEventAge. Only maxEventTime will be used.&quot;);
		}
<span class="pc bpc" id="L116" title="1 of 4 branches missed.">		if (maxEventAge != null &amp;&amp; minEventTime != null) {</span>
<span class="nc" id="L117">			LOGGER.config(&quot;Both maxEventAge and minEventTime were specified. &quot;</span>
					+ &quot;Ignoring maxEventAge. Only minEventTime will be used.&quot;);
		}

<span class="pc bpc" id="L121" title="2 of 12 branches missed.">		if ((minAge != null || maxAge != null)</span>
				&amp;&amp; (minEventAge != null || maxEventAge != null
						|| minEventTime != null || maxEventTime != null)) {

<span class="fc" id="L125">			ConfigurationException ce = new ConfigurationException(</span>
					&quot;Configuration mismatch. Can not specify both &quot;
							+ &quot;minAge/maxAge (legacy) properties as well as &quot;
							+ &quot;minEventAge/maxEventAge or minEventTime/maxEventTime.&quot;);

<span class="fc" id="L130">			ce.fillInStackTrace();</span>
<span class="fc" id="L131">			throw ce;</span>
		}

<span class="fc bfc" id="L134" title="All 4 branches covered.">		if ((minEventAge != null &amp;&amp; maxEventAge != null)</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">				&amp;&amp; (minEventAge &gt; maxEventAge)) {</span>

<span class="fc" id="L137">			ConfigurationException ce = new ConfigurationException(</span>
					&quot;Configuration mismatch. minEventAge &quot;
							+ &quot;greater than maxEventAge.&quot;);
<span class="fc" id="L140">			ce.fillInStackTrace();</span>
<span class="fc" id="L141">			throw ce;</span>
		}

<span class="pc bpc" id="L144" title="1 of 4 branches missed.">		if ((minEventTime != null &amp;&amp; maxEventTime != null)</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">				&amp;&amp; (minEventTime &gt; maxEventTime)) {</span>

<span class="fc" id="L147">			ConfigurationException ce = new ConfigurationException(</span>
					&quot;Configuration mismatch. minEventTime &quot;
							+ &quot;greater than maxEventTime.&quot;);
<span class="fc" id="L150">			ce.fillInStackTrace();</span>
<span class="fc" id="L151">			throw ce;</span>
		}

<span class="fc" id="L154">		minMag = parseBigDecimal(config, ARCHIVE_MIN_MAG_PROPERTY);</span>
<span class="fc" id="L155">		maxMag = parseBigDecimal(config, ARCHIVE_MAX_MAG_PROPERTY);</span>
<span class="fc" id="L156">		minLat = parseBigDecimal(config, ARCHIVE_MIN_LAT_PROPERTY);</span>
<span class="fc" id="L157">		maxLat = parseBigDecimal(config, ARCHIVE_MAX_LAT_PROPERTY);</span>
<span class="fc" id="L158">		minLng = parseBigDecimal(config, ARCHIVE_MIN_LNG_PROPERTY);</span>
<span class="fc" id="L159">		maxLng = parseBigDecimal(config, ARCHIVE_MAX_LNG_PROPERTY);</span>
<span class="fc" id="L160">		minDepth = parseBigDecimal(config, ARCHIVE_MIN_DEPTH_PROPERTY);</span>
<span class="fc" id="L161">		maxDepth = parseBigDecimal(config, ARCHIVE_MAX_DEPTH_PROPERTY);</span>
<span class="fc" id="L162">		eventSource = config.getProperty(ARCHIVE_EVENT_SOURCE_PROPERTY);</span>
<span class="fc" id="L163">	}</span>

	@Override
	public void shutdown() throws Exception {
		// Nothing to do
<span class="nc" id="L168">	}</span>

	@Override
	public void startup() throws Exception {
		// Nothing to do
<span class="nc" id="L173">	}</span>

	public ProductIndexQuery getIndexQuery() {
<span class="fc" id="L176">		ProductIndexQuery productIndexQuery = new ProductIndexQuery();</span>
<span class="fc" id="L177">		Date now = new Date();</span>

<span class="fc bfc" id="L179" title="All 2 branches covered.">		if (minAge != null) {</span>
			// min age corresponds to minimum event time
<span class="fc" id="L181">			productIndexQuery.setMinEventTime(new Date(now.getTime()</span>
<span class="fc" id="L182">					- minAge.longValue()));</span>
		}
<span class="fc bfc" id="L184" title="All 2 branches covered.">		if (maxAge != null) {</span>
			// max age corresponds to maximum event time
<span class="fc" id="L186">			productIndexQuery.setMaxEventTime(new Date(now.getTime()</span>
<span class="fc" id="L187">					- maxAge.longValue()));</span>
		}

		/*-
		 Epoch                                                            Now
		   |------------------- maxAge &lt;---------------------------------- |
		   |                       |                                       |
		   |                       |                minAge &lt;---------------|
		   |                       |                   |                   |
		   |-----------------------|-------------------|-------------------|
		   |                       |                   |
		   |------------------&gt; minTime                |
		   |                                           |
		   |--------------------------------------&gt; maxTime
		   
		 Simple Example (not to scale)
		 
		   0 (Epoch)                                              (Now) 100,000
		   |------------------- maxAge &lt;--- (10,000) --------------------- |
		   |                       |                                       |
		   |                       |                minAge &lt;--- (1,000) ---|
		   |                       |                   |                   |
		   |-------------------- 90,000 ************ 99,000 ---------------|
		   |                       |                   |
		   |----- (90,000) ---&gt; minTime                |
		   |                                           |
		   |------------------------- (99,000) ---&gt; maxTime
		   
		   Events occurring in the *** time span will match the query and be
		   archived.
		 */

<span class="fc bfc" id="L219" title="All 2 branches covered.">		if (maxEventAge != null) {</span>
<span class="fc" id="L220">			productIndexQuery.setMinEventTime(new Date(now.getTime()</span>
<span class="fc" id="L221">					- maxEventAge.longValue()));</span>
		}
<span class="fc bfc" id="L223" title="All 2 branches covered.">		if (minEventAge != null) {</span>
<span class="fc" id="L224">			productIndexQuery.setMaxEventTime(new Date(now.getTime()</span>
<span class="fc" id="L225">					- minEventAge.longValue()));</span>
		}

<span class="pc bpc" id="L228" title="1 of 2 branches missed.">		if (minEventTime != null) {</span>
<span class="nc" id="L229">			productIndexQuery</span>
<span class="nc" id="L230">					.setMinEventTime(new Date(minEventTime.longValue()));</span>
		}
<span class="fc bfc" id="L232" title="All 2 branches covered.">		if (maxEventTime != null) {</span>
<span class="fc" id="L233">			productIndexQuery</span>
<span class="fc" id="L234">					.setMaxEventTime(new Date(maxEventTime.longValue()));</span>
		}

<span class="fc" id="L237">		productIndexQuery.setMinEventMagnitude(minMag);</span>
<span class="fc" id="L238">		productIndexQuery.setMaxEventMagnitude(maxMag);</span>
<span class="fc" id="L239">		productIndexQuery.setMinEventLatitude(minLat);</span>
<span class="fc" id="L240">		productIndexQuery.setMaxEventLatitude(maxLat);</span>
<span class="fc" id="L241">		productIndexQuery.setMinEventLongitude(minLng);</span>
<span class="fc" id="L242">		productIndexQuery.setMaxEventLongitude(maxLng);</span>
<span class="fc" id="L243">		productIndexQuery.setMinEventDepth(minDepth);</span>
<span class="fc" id="L244">		productIndexQuery.setMaxEventDepth(maxDepth);</span>
<span class="fc" id="L245">		productIndexQuery.setEventSource(eventSource);</span>

		// this archive policy is only for events, only remove events based on
		// their preferred properties
<span class="fc" id="L249">		productIndexQuery</span>
<span class="fc" id="L250">				.setEventSearchType(ProductIndexQuery.SEARCH_EVENT_PREFERRED);</span>
		
<span class="fc" id="L252">		productIndexQuery.setResultType(ProductIndexQuery.RESULT_TYPE_ALL);</span>
		
<span class="fc" id="L254">		return productIndexQuery;</span>
	}

	public boolean isValidPolicy() {
		// Not valid if using both old and new configuration methods
<span class="pc bpc" id="L259" title="6 of 8 branches missed.">		boolean valid = !((minAge != null || maxAge != null) &amp;&amp; (minEventAge != null || maxEventAge != null));</span>

<span class="pc bpc" id="L261" title="28 of 32 branches missed.">		return valid</span>
				&amp;&amp; (minAge != null || maxAge != null || minEventAge != null
						|| maxEventAge != null || minEventTime != null
						|| maxEventTime != null || minMag != null
						|| maxMag != null || minLat != null || maxLat != null
						|| minLng != null || maxLng != null || minDepth != null
						|| maxDepth != null || eventSource != null);
	}

	protected BigDecimal parseBigDecimal(Config config, String name) {
<span class="fc" id="L271">		BigDecimal property = null;</span>
		try {
<span class="fc" id="L273">			String buffer = config.getProperty(name);</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">			if (buffer != null) {</span>
<span class="nc" id="L275">				property = new BigDecimal(buffer);</span>
			}
<span class="nc" id="L277">		} catch (NumberFormatException npx) {</span>
<span class="nc" id="L278">			property = null;</span>
<span class="fc" id="L279">		}</span>
<span class="fc" id="L280">		return property;</span>
	}

	protected Long parseDateOrLong(Config config, String name) {
<span class="fc" id="L284">		Long property = null;</span>
		try {
<span class="fc" id="L286">			String buffer = config.getProperty(name);</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">			if (buffer != null) {</span>
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">				if (buffer.indexOf(&quot;T&quot;) != -1) {</span>
					// try parsing as date
<span class="nc" id="L290">					Date date = ISO8601.parse(buffer);</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">					if (date != null) {</span>
<span class="nc" id="L292">						property = date.getTime();</span>
					}
<span class="nc" id="L294">				} else {</span>
<span class="fc" id="L295">					property = Long.valueOf(buffer);</span>
				}
			}
<span class="nc" id="L298">		} catch (NumberFormatException npx) {</span>
<span class="nc" id="L299">			property = null;</span>
<span class="fc" id="L300">		}</span>
<span class="fc" id="L301">		return property;</span>
	}

	protected Long parseLong(Config config, String name) {
<span class="fc" id="L305">		Long property = null;</span>
		try {
<span class="fc" id="L307">			String buffer = config.getProperty(name);</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">			if (buffer != null) {</span>
<span class="fc" id="L309">				property = Long.valueOf(buffer);</span>
			}
<span class="nc" id="L311">		} catch (NumberFormatException npx) {</span>
<span class="nc" id="L312">			property = null;</span>
<span class="fc" id="L313">		}</span>
<span class="fc" id="L314">		return property;</span>
	}

	/** @deprecated */
	public Long getMinAge() {
<span class="nc" id="L319">		return minAge;</span>
	}

	/** @deprecated */
	public void setMinAge(Long minAge) {
<span class="nc" id="L324">		this.minAge = minAge;</span>
<span class="nc" id="L325">	}</span>

	/** @deprecated */
	public Long getMaxAge() {
<span class="nc" id="L329">		return maxAge;</span>
	}

	/** @deprecated */
	public void setMaxAge(Long maxAge) {
<span class="nc" id="L334">		this.maxAge = maxAge;</span>
<span class="nc" id="L335">	}</span>

	public Long getMinEventAge() {
<span class="nc" id="L338">		return minEventAge;</span>
	}

	public void setMinEventAge(Long minEventAge) {
<span class="nc" id="L342">		this.minEventAge = minEventAge;</span>
<span class="nc" id="L343">	}</span>

	public Long getMaxEventAge() {
<span class="nc" id="L346">		return maxEventAge;</span>
	}

	public void setMaxEventAge(Long maxEventAge) {
<span class="nc" id="L350">		this.maxEventAge = maxEventAge;</span>
<span class="nc" id="L351">	}</span>

	public Long getMinEventTime() {
<span class="nc" id="L354">		return minEventTime;</span>
	}

	public void setMinEventTime(Long minEventTime) {
<span class="nc" id="L358">		this.minEventTime = minEventTime;</span>
<span class="nc" id="L359">	}</span>

	public Long getMaxEventTime() {
<span class="nc" id="L362">		return maxEventTime;</span>
	}

	public void setMaxEventTime(Long maxEventTime) {
<span class="nc" id="L366">		this.maxEventTime = maxEventTime;</span>
<span class="nc" id="L367">	}</span>

	public BigDecimal getMinMag() {
<span class="nc" id="L370">		return minMag;</span>
	}

	public void setMinMag(BigDecimal minMag) {
<span class="nc" id="L374">		this.minMag = minMag;</span>
<span class="nc" id="L375">	}</span>

	public BigDecimal getMaxMag() {
<span class="nc" id="L378">		return maxMag;</span>
	}

	public void setMaxMag(BigDecimal maxMag) {
<span class="nc" id="L382">		this.maxMag = maxMag;</span>
<span class="nc" id="L383">	}</span>

	public BigDecimal getMinLat() {
<span class="nc" id="L386">		return minLat;</span>
	}

	public void setMinLat(BigDecimal minLat) {
<span class="nc" id="L390">		this.minLat = minLat;</span>
<span class="nc" id="L391">	}</span>

	public BigDecimal getMaxLat() {
<span class="nc" id="L394">		return maxLat;</span>
	}

	public void setMaxLat(BigDecimal maxLat) {
<span class="nc" id="L398">		this.maxLat = maxLat;</span>
<span class="nc" id="L399">	}</span>

	public BigDecimal getMinLng() {
<span class="nc" id="L402">		return minLng;</span>
	}

	public void setMinLng(BigDecimal minLng) {
<span class="nc" id="L406">		this.minLng = minLng;</span>
<span class="nc" id="L407">	}</span>

	public BigDecimal getMaxLng() {
<span class="nc" id="L410">		return maxLng;</span>
	}

	public void setMaxLng(BigDecimal maxLng) {
<span class="nc" id="L414">		this.maxLng = maxLng;</span>
<span class="nc" id="L415">	}</span>

	public BigDecimal getMinDepth() {
<span class="nc" id="L418">		return minDepth;</span>
	}

	public void setMinDepth(BigDecimal minDepth) {
<span class="nc" id="L422">		this.minDepth = minDepth;</span>
<span class="nc" id="L423">	}</span>

	public BigDecimal getMaxDepth() {
<span class="nc" id="L426">		return maxDepth;</span>
	}

	public void setMaxDepth(BigDecimal maxDepth) {
<span class="nc" id="L430">		this.maxDepth = maxDepth;</span>
<span class="nc" id="L431">	}</span>

	public String getEventSource() {
<span class="nc" id="L434">		return eventSource;</span>
	}

	public void setEventSource(String eventSource) {
<span class="fc" id="L438">		this.eventSource = eventSource;</span>
<span class="fc" id="L439">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>